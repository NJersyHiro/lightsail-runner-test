name: Test 3 - Dynamic Port Allocation

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  port-allocation-test:
    runs-on: self-hosted
    strategy:
      matrix:
        service: [web, api, db]
    steps:
      - name: Show runner info
        run: |
          echo "ğŸƒ Runner: $RUNNER_NAME"
          echo "ğŸ”§ Service: ${{ matrix.service }}"
      
      - name: Find and allocate dynamic port
        run: |
          echo "ğŸ” Finding available port for ${{ matrix.service }} service..."
          
          # Method 1: Using Python
          PORT=$(python3 -c 'import socket; s=socket.socket(); s.bind(("", 0)); print(s.getsockname()[1]); s.close()')
          echo "PORT=$PORT" >> $GITHUB_ENV
          echo "âœ… Allocated port via Python: $PORT"
          
          # Method 2: Using shell (alternative)
          ALT_PORT=$(comm -23 <(seq 49152 65535 | sort) <(ss -tan | awk '{print $4}' | cut -d':' -f2 | grep -E '[0-9]+' | sort -u) | head -1)
          echo "ALT_PORT=$ALT_PORT" >> $GITHUB_ENV
          echo "âœ… Alternative port via shell: $ALT_PORT"
      
      - uses: actions/checkout@v4
      
      - name: Start service with dynamic port
        run: |
          echo "ğŸš€ Starting ${{ matrix.service }} service on port $PORT"
          
          # ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ã®ä»£ã‚ã‚Šã«ncã‚’ä½¿ç”¨ï¼‰
          case "${{ matrix.service }}" in
            web)
              # Webã‚µãƒ¼ãƒãƒ¼ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
              timeout 30s bash -c "while true; do echo -e 'HTTP/1.1 200 OK\n\nWeb Server on $RUNNER_NAME:$PORT' | nc -l -p $PORT -q 1; done" &
              WEB_PID=$!
              echo "WEB_PID=$WEB_PID" >> $GITHUB_ENV
              ;;
            api)
              # APIã‚µãƒ¼ãƒãƒ¼ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
              timeout 30s bash -c "while true; do echo -e 'HTTP/1.1 200 OK\n\n{\"api\":\"running\",\"runner\":\"$RUNNER_NAME\",\"port\":$PORT}' | nc -l -p $PORT -q 1; done" &
              API_PID=$!
              echo "API_PID=$API_PID" >> $GITHUB_ENV
              ;;
            db)
              # DBã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
              echo "Database simulator on port $PORT" > /tmp/db-$PORT.txt
              ;;
          esac
          
          sleep 2
          echo "âœ… Service started"
      
      - name: Test service connectivity
        run: |
          echo "ğŸ§ª Testing service connectivity..."
          
          case "${{ matrix.service }}" in
            web|api)
              # ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
              if nc -zv localhost $PORT 2>&1 | grep -q succeeded; then
                echo "âœ… Service is listening on port $PORT"
                
                # ç°¡å˜ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ
                echo "ğŸ“¡ Sending test request..."
                echo -e "GET / HTTP/1.1\nHost: localhost\n\n" | nc localhost $PORT -w 2 || echo "Request completed"
              else
                echo "âŒ Service is not listening on port $PORT"
              fi
              ;;
            db)
              if [ -f "/tmp/db-$PORT.txt" ]; then
                echo "âœ… Database file exists:"
                cat "/tmp/db-$PORT.txt"
              fi
              ;;
          esac
      
      - name: Show port usage
        run: |
          echo "ğŸ“Š Current port usage by this workflow:"
          echo "- ${{ matrix.service }} service: $PORT"
          echo ""
          echo "ğŸ” All listeners on this system:"
          ss -tlnp 2>/dev/null | grep -E ":(4[0-9]{4}|5[0-9]{4}|6[0-9]{4})" | head -10 || echo "No high ports in use"
      
      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          
          # ãƒ—ãƒ­ã‚»ã‚¹ã®çµ‚äº†
          [ ! -z "$WEB_PID" ] && kill $WEB_PID 2>/dev/null || true
          [ ! -z "$API_PID" ] && kill $API_PID 2>/dev/null || true
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
          rm -f /tmp/db-$PORT.txt
          
          echo "âœ… Cleanup completed"