name: Test 2 - Dynamic Directories

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  dynamic-dir-test:
    runs-on: self-hosted
    strategy:
      matrix:
        test_id: [1, 2, 3]
    steps:
      - name: Show runner and job info
        run: |
          echo "üèÉ Runner: $RUNNER_NAME"
          echo "üî¢ Test ID: ${{ matrix.test_id }}"
          echo "üÜî Run ID: ${{ github.run_id }}"
      
      - name: Create unique directories
        run: |
          # „É©„É≥„Éä„ÉºÂêç„Å®„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åß„É¶„Éã„Éº„ÇØÂåñ
          BUILD_DIR="/tmp/build-${RUNNER_NAME}-$(date +%s%N)"
          mkdir -p $BUILD_DIR
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "‚úÖ Created build directory: $BUILD_DIR"
          
          # „Éá„Éº„Çø„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇÇ‰ΩúÊàê
          DATA_DIR="/tmp/data-${RUNNER_NAME}-${{ matrix.test_id }}-$(date +%s)"
          mkdir -p $DATA_DIR
          echo "DATA_DIR=$DATA_DIR" >> $GITHUB_ENV
          echo "‚úÖ Created data directory: $DATA_DIR"
      
      - uses: actions/checkout@v4
      
      - name: Build simulation
        run: |
          cd $BUILD_DIR
          echo "üî® Building in: $BUILD_DIR"
          
          # „Éì„É´„Éâ„Éó„É≠„Çª„Çπ„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
          echo "Building project..." > build.log
          echo "Runner: $RUNNER_NAME" >> build.log
          echo "Matrix ID: ${{ matrix.test_id }}" >> build.log
          echo "Timestamp: $(date)" >> build.log
          
          # „Éì„É´„ÉâÊàêÊûúÁâ©„ÅÆ‰ΩúÊàê
          mkdir -p output
          echo "Build artifact from $RUNNER_NAME - Test ${{ matrix.test_id }}" > output/artifact.txt
          
          # 5ÁßíÈñì„ÅÆ„Éì„É´„Éâ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
          for i in {1..5}; do
            echo "Build step $i/5..." >> build.log
            sleep 1
          done
          
          echo "‚úÖ Build completed"
          cat build.log
      
      - name: Data processing
        run: |
          cd $DATA_DIR
          echo "üìä Processing data in: $DATA_DIR"
          
          # „Éá„Éº„ÇøÂá¶ÁêÜ„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
          for i in {1..3}; do
            echo "Data point $i from $RUNNER_NAME" > "data-$i.txt"
          done
          
          ls -la
      
      - name: Verify isolation
        run: |
          echo "üîç Verifying directory isolation..."
          echo "Build directory contents:"
          ls -la $BUILD_DIR || echo "Build directory not accessible"
          echo ""
          echo "Data directory contents:"
          ls -la $DATA_DIR || echo "Data directory not accessible"
          echo ""
          echo "Checking /tmp for all build directories:"
          ls -la /tmp | grep "build-" | head -10 || echo "No build directories found"
      
      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up directories..."
          [ -d "$BUILD_DIR" ] && rm -rf "$BUILD_DIR" && echo "Removed: $BUILD_DIR"
          [ -d "$DATA_DIR" ] && rm -rf "$DATA_DIR" && echo "Removed: $DATA_DIR"